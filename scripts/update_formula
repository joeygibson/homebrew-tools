#!/usr/bin/env bash
set -euo pipefail

# Usage: update_formula <formula-name>
# Example: update_formula jsonquill

if [[ $# -ne 1 ]]; then
    echo "Usage: update_formula <formula-name>" >&2
    echo "Example: update_formula jsonquill" >&2
    exit 1
fi

formula_name="$1"
formula_file="Formula/${formula_name}.rb"

if [[ ! -f "$formula_file" ]]; then
    echo "Error: Formula file not found: $formula_file" >&2
    exit 1
fi

# Check required dependencies
for cmd in gh curl shasum sed git jq; do
    if ! command -v "$cmd" &> /dev/null; then
        echo "Error: Required command '$cmd' not found" >&2
        echo "Please install $cmd and try again" >&2
        exit 1
    fi
done

# Extract current version from formula URL line
url_line=$(grep '^\s*url "' "$formula_file")
if [[ ! "$url_line" =~ tags/v([0-9.]+)\.tar\.gz ]]; then
    echo "Error: Could not extract version from formula URL" >&2
    exit 1
fi
current_version="${BASH_REMATCH[1]}"

# Extract GitHub repository (owner/repo)
if [[ ! "$url_line" =~ github\.com/([^/]+)/([^/]+)/archive ]]; then
    echo "Error: Could not extract GitHub repository from formula URL" >&2
    exit 1
fi
repo_owner="${BASH_REMATCH[1]}"
repo_name="${BASH_REMATCH[2]}"
repo="$repo_owner/$repo_name"

echo "Current version: v$current_version"
echo "Repository: $repo"

# Fetch latest release from GitHub
echo "Fetching latest release for $repo..."
if ! release_json=$(gh api "repos/$repo/releases/latest" 2>&1); then
    echo "Error: Failed to fetch latest release from GitHub" >&2
    echo "$release_json" >&2
    exit 1
fi

# Extract tag name and strip leading 'v'
tag_name=$(echo "$release_json" | jq -r '.tag_name')
latest_version="${tag_name#v}"

# Compare versions
if [[ "$current_version" == "$latest_version" ]]; then
    echo "Formula $formula_name is already at latest version v$latest_version"
    exit 0
fi

echo "Update available: v$current_version -> v$latest_version"

# Compute SHA256 for new version
tarball_url="https://github.com/$repo/archive/refs/tags/v${latest_version}.tar.gz"
echo "Computing SHA256 for $tarball_url..."
if ! sha_output=$(curl -sL "$tarball_url" | shasum -a 256 2>&1); then
    echo "Error: Failed to download tarball or compute SHA256" >&2
    echo "$sha_output" >&2
    exit 1
fi

# Extract just the hash (first field)
new_sha256=$(echo "$sha_output" | awk '{print $1}')
echo "New SHA256: $new_sha256"

# Update formula file
echo ""
echo "Updating $formula_file..."

# Update version in URL line
sed -i '' "s|tags/v[0-9.]*\.tar\.gz|tags/v${latest_version}.tar.gz|" "$formula_file"

# Update SHA256 line
sed -i '' "s|sha256 \".*\"|sha256 \"$new_sha256\"|" "$formula_file"

# Show what changed
echo ""
echo "Changes made:"
git diff "$formula_file"

# Create git commit
echo ""
echo "Creating commit..."
git add "$formula_file"

commit_message="Update $formula_name to v$latest_version

- Updated from v$current_version to v$latest_version
- Updated SHA256 checksum

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

if ! git commit -m "$commit_message" 2>&1; then
    echo "Error: Failed to create git commit" >&2
    echo "Formula file has been updated but not committed" >&2
    exit 1
fi

commit_sha=$(git rev-parse --short HEAD)
echo "Successfully updated $formula_name from v$current_version to v$latest_version"
echo "Commit: $commit_sha"
