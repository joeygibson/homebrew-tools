#!/usr/bin/env bash
set -euo pipefail

# Usage: update_formula <formula-name>
# Example: update_formula jsonquill

if [[ $# -ne 1 ]]; then
    echo "Usage: update_formula <formula-name>" >&2
    echo "Example: update_formula jsonquill" >&2
    exit 1
fi

formula_name="$1"
formula_file="Formula/${formula_name}.rb"

if [[ ! -f "$formula_file" ]]; then
    echo "Error: Formula file not found: $formula_file" >&2
    exit 1
fi

# Check required dependencies
for cmd in gh curl shasum sed git jq; do
    if ! command -v "$cmd" &> /dev/null; then
        echo "Error: Required command '$cmd' not found" >&2
        echo "Please install $cmd and try again" >&2
        exit 1
    fi
done

# Extract current version from the version line
version_line=$(grep '^\s*version "' "$formula_file")
if [[ ! "$version_line" =~ version\ \"([0-9.]+)\" ]]; then
    echo "Error: Could not extract version from formula" >&2
    exit 1
fi
current_version="${BASH_REMATCH[1]}"

# Extract GitHub repository (owner/repo) from a URL line
url_line=$(grep '^\s*url "' "$formula_file" | head -1)
if [[ ! "$url_line" =~ github\.com/([^/]+)/([^/]+)/releases ]]; then
    echo "Error: Could not extract GitHub repository from formula URL" >&2
    exit 1
fi
repo_owner="${BASH_REMATCH[1]}"
repo_name="${BASH_REMATCH[2]}"
repo="$repo_owner/$repo_name"

echo "Current version: v$current_version"
echo "Repository: $repo"

# Fetch latest release from GitHub
echo "Fetching latest release for $repo..."
if ! release_json=$(gh api "repos/$repo/releases/latest" 2>&1); then
    echo "Error: Failed to fetch latest release from GitHub" >&2
    echo "$release_json" >&2
    exit 1
fi

# Extract tag name and strip leading 'v'
tag_name=$(echo "$release_json" | jq -r '.tag_name')
latest_version="${tag_name#v}"

# Compare versions
if [[ "$current_version" == "$latest_version" ]]; then
    echo "Formula $formula_name is already at latest version v$latest_version"
    exit 0
fi

echo "Update available: v$current_version -> v$latest_version"

# Define the platform-specific asset names
assets=(
    "${formula_name}-macos-aarch64.tar.gz"
    "${formula_name}-macos-x86_64.tar.gz"
    "${formula_name}-linux-x86_64.tar.gz"
)

# Compute SHA256 for each platform binary
declare -A sha256s
for asset in "${assets[@]}"; do
    asset_url="https://github.com/$repo/releases/download/v${latest_version}/${asset}"
    echo "Computing SHA256 for $asset..."
    if ! sha_output=$(curl -sL "$asset_url" | shasum -a 256 2>&1); then
        echo "Error: Failed to download or compute SHA256 for $asset" >&2
        echo "$sha_output" >&2
        exit 1
    fi
    sha256s["$asset"]=$(echo "$sha_output" | awk '{print $1}')
    echo "  ${sha256s[$asset]}"
done

# Update formula file
echo ""
echo "Updating $formula_file..."

# Update the version line
sed -i '' "s|version \"${current_version}\"|version \"${latest_version}\"|" "$formula_file"

# Update all URL lines (replace old version with new in download URLs)
sed -i '' "s|/download/v${current_version}/|/download/v${latest_version}/|" "$formula_file"

# Update each platform's SHA256 by finding the URL line and updating the sha256 on the next line
for asset in "${assets[@]}"; do
    new_sha="${sha256s[$asset]}"
    # Use awk to find the URL line containing this asset and update the next sha256 line
    awk -v asset="$asset" -v new_sha="$new_sha" '
        found && /sha256/ {
            sub(/sha256 ".*"/, "sha256 \"" new_sha "\"")
            found = 0
        }
        { found = ($0 ~ asset); print }
    ' "$formula_file" > "${formula_file}.tmp" && mv "${formula_file}.tmp" "$formula_file"
done

# Show what changed
echo ""
echo "Changes made:"
git diff "$formula_file"

# Create git commit
echo ""
echo "Creating commit..."
git add "$formula_file"

commit_message="Update $formula_name to v$latest_version

- Updated from v$current_version to v$latest_version
- Updated SHA256 checksums for all platform binaries

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>"

if ! git commit -m "$commit_message" 2>&1; then
    echo "Error: Failed to create git commit" >&2
    echo "Formula file has been updated but not committed" >&2
    exit 1
fi

commit_sha=$(git rev-parse --short HEAD)
echo "Successfully updated $formula_name from v$current_version to v$latest_version"
echo "Commit: $commit_sha"
